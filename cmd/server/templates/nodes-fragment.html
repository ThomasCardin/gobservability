{{range .}}
<div class="node-card" data-node-name="{{.Name}}">
    <!-- Node Header -->
    <div class="node-header">
        <span class="node-timestamp">üïê {{.Timestamp}}</span>
        <h3 class="node-name">{{.Name}}</h3>
        <div class="node-actions">
            <button class="action-btn alerts-btn" onclick="toggleAlerts('{{.Name}}')">üö® ALERTS</button>
            <button class="action-btn pods-btn" onclick="togglePods('{{.Name}}')">üöÄ PODS</button>
        </div>
    </div>
    
    {{if .CPU}}
    <!-- Metrics Grid (2x2) -->
    <div class="metrics-grid">
        <!-- CPU Card -->
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">üî• CPU</span>
                <span class="metric-value main-value" data-node="{{.Name}}" data-metric="cpu-total">{{printf "%.1f%%" .CPUTotal}}</span>
            </div>
            <div class="metric-details">
                <div class="detail-row">
                    <div class="cpu-label">
                        <span>User</span>
                        <span class="cpu-sub-inline">niced ({{printf "%.1f%%" .CPUNiceRaw}})</span>
                    </div>
                    <span class="metric-value" data-node="{{.Name}}" data-metric="cpu-user">{{printf "%.1f%%" .CPUUser}}</span>
                </div>
                <div class="detail-row">
                    <div class="cpu-label">
                        <span>System</span>
                        <span class="cpu-sub-inline">irq({{printf "%.1f%%" .CPUIRQRaw}}) sirq({{printf "%.1f%%" .CPUSIRQRaw}})</span>
                    </div>
                    <span class="metric-value" data-node="{{.Name}}" data-metric="cpu-system">{{printf "%.1f%%" .CPUSystem}}</span>
                </div>
            </div>
        </div>
        
        <!-- Memory Card -->
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">üß† MEMORY</span>
                <span class="metric-value main-value" data-node="{{.Name}}" data-metric="memory-total">{{.Memory}}</span>
            </div>
            <div class="metric-details">
                <div class="detail-row">
                    <span>Used</span>
                    <span class="metric-value" data-node="{{.Name}}" data-metric="memory-used">{{printf "%.1fG" .MemoryUsed}}</span>
                </div>
                <div class="detail-row">
                    <span>Free</span>
                    <span class="metric-value" data-node="{{.Name}}" data-metric="memory-free">{{printf "%.1fG" .MemoryFree}}</span>
                </div>
            </div>
        </div>
        
        <!-- Network Card -->
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">üåê NETWORK</span>
                <span class="metric-value main-value" data-node="{{.Name}}" data-metric="network-total">{{printf "%.1fM" .NetworkTotal}}</span>
            </div>
            <div class="metric-details">
                <div class="detail-row">
                    <span>RX</span>
                    <span class="metric-value" data-node="{{.Name}}" data-metric="network-rx">{{printf "%.1fM" .NetworkRX}}</span>
                </div>
                <div class="detail-row">
                    <span>TX</span>
                    <span class="metric-value" data-node="{{.Name}}" data-metric="network-tx">{{printf "%.1fM" .NetworkTX}}</span>
                </div>
            </div>
        </div>
        
        <!-- Disk Card -->
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">üíæ DISK</span>
                <span class="metric-value main-value" data-node="{{.Name}}" data-metric="disk-total">{{printf "%.1fM" .DiskTotal}}</span>
            </div>
            <div class="metric-details">
                <div class="detail-row">
                    <span>Read</span>
                    <span class="metric-value" data-node="{{.Name}}" data-metric="disk-read">{{printf "%.1fM" .DiskRead}}</span>
                </div>
                <div class="detail-row">
                    <span>Write</span>
                    <span class="metric-value" data-node="{{.Name}}" data-metric="disk-write">{{printf "%.1fM" .DiskWrite}}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden sections -->
    <div class="alerts-section" id="alerts-{{.Name}}" style="display: none;">
        <div class="section-header">Alerts</div>
        <div class="alert-item">No active alerts</div>
    </div>
    
    <div class="pods-section" id="pods-{{.Name}}" style="display: none;">
        <div class="section-header">Node Pods</div>
        <div class="pods-list">
            <div class="pod-item">kube-proxy-xyz</div>
            <div class="pod-item">calico-node-abc</div>
            <div class="pod-item">app-service-123</div>
        </div>
    </div>
    {{else}}
    <div class="error-state">En attente des donn√©es...</div>
    {{end}}
</div>
{{end}}

<script>
function togglePods(nodeName) {
    const podsSection = document.getElementById('pods-' + nodeName);
    podsSection.style.display = podsSection.style.display === 'none' ? 'block' : 'none';
}

function toggleAlerts(nodeName) {
    const alertsSection = document.getElementById('alerts-' + nodeName);
    alertsSection.style.display = alertsSection.style.display === 'none' ? 'block' : 'none';
}

// Store previous values for change detection
let previousValues = new Map();

// Initialize or update value tracking
function trackValueChanges() {
    const elements = document.querySelectorAll('[data-node][data-metric]');
    
    elements.forEach(element => {
        const nodeId = element.dataset.node;
        const metric = element.dataset.metric;
        const key = `${nodeId}-${metric}`;
        
        let currentValue;
        
        // Extract current value from different element types
        if (element.classList.contains('section-value')) {
            // Extract from parentheses: "(23.4%)" -> "23.4%"
            const match = element.textContent.match(/\(([^)]+)\)/);
            currentValue = match ? match[1] : element.textContent;
        } else if (element.classList.contains('metric-value')) {
            currentValue = element.textContent;
        } else {
            // For spans with nested metric-value
            const valueSpan = element.querySelector('.metric-value');
            if (valueSpan) {
                currentValue = valueSpan.textContent;
            } else {
                // Extract value after colon: "User: 23.4%" -> "23.4%"
                const match = element.textContent.match(/:\s*([0-9.]+[%GM]?)/);
                currentValue = match ? match[1] : element.textContent;
            }
        }
        
        // Check if value changed
        if (previousValues.has(key) && previousValues.get(key) !== currentValue) {
            // Value changed - animate it
            animateValueChange(element);
        }
        
        // Store current value for next comparison
        previousValues.set(key, currentValue);
    });
}

function animateValueChange(element) {
    // Add animation class
    element.classList.add('value-changed');
    
    // Also animate nested metric-value spans if they exist
    const metricValues = element.querySelectorAll('.metric-value');
    metricValues.forEach(span => {
        span.classList.add('value-changed');
    });
    
    // Remove animation class after animation completes (1.5 seconds)
    setTimeout(() => {
        element.classList.remove('value-changed');
        metricValues.forEach(span => {
            span.classList.remove('value-changed');
        });
    }, 1500);
}

// Initialize tracking on first load
document.addEventListener('DOMContentLoaded', function() {
    trackValueChanges();
});

// Track changes after each HTMX update
document.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'workersList') {
        trackValueChanges();
        applyNodeColors();
    }
});

// Apply subtle border to each node card
function applyNodeColors() {
    const nodeCards = document.querySelectorAll('[data-node-name]');
    
    nodeCards.forEach((card, index) => {
        // Simple subtle border that goes around the whole card
        card.style.border = '2px solid #58a6ff';
        card.style.borderRadius = '8px';
        
        // Or alternative: just add a small number badge
        // const nodeName = card.querySelector('.node-name');
        // nodeName.innerHTML = `<span class="node-badge">${String(index + 1).padStart(2, '0')}</span> ${nodeName.textContent}`;
    });
}

// Simple hash function to generate consistent colors
function hashCode(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
    }
    return Math.abs(hash);
}

// Apply colors on initial load
document.addEventListener('DOMContentLoaded', function() {
    applyNodeColors();
});
</script>
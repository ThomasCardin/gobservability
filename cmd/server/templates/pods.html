<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pods - {{.NodeName}} | gobservability</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
    <div id="app">
        <div class="header">
            <a href="/" class="back-btn">‚Üê Back to Dashboard</a>
            <h1>Pods on {{.NodeName}}</h1>
        </div>
        
        <!-- Node Section (Auto-updating with title) -->
        <div id="nodeMetrics" hx-get="/pods/{{.NodeName}}/metrics" hx-trigger="every 2s" hx-swap="innerHTML">
            {{if .CPU}}
            <div class="metrics-grid">
                <!-- CPU Card -->
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">üî• CPU</span>
                        <span class="metric-value main-value" data-node="{{.NodeName}}" data-metric="cpu-total">{{printf "%.1f%%" .CPUTotal}}</span>
                    </div>
                    <div class="metric-details">
                        <div class="detail-row">
                            <div class="cpu-label">
                                <span>User</span>
                                <span class="cpu-sub-inline">niced ({{printf "%.1f%%" .CPUNiceRaw}})</span>
                            </div>
                            <span class="metric-value" data-node="{{.NodeName}}" data-metric="cpu-user">{{printf "%.1f%%" .CPUUser}}</span>
                        </div>
                        <div class="detail-row">
                            <div class="cpu-label">
                                <span>System</span>
                                <span class="cpu-sub-inline">irq({{printf "%.1f%%" .CPUIRQRaw}}) sirq({{printf "%.1f%%" .CPUSIRQRaw}})</span>
                            </div>
                            <span class="metric-value" data-node="{{.NodeName}}" data-metric="cpu-system">{{printf "%.1f%%" .CPUSystem}}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Memory Card -->
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">üß† MEMORY</span>
                        <span class="metric-value main-value" data-node="{{.NodeName}}" data-metric="memory-total">{{.Memory}}</span>
                    </div>
                    <div class="metric-details">
                        <div class="detail-row">
                            <span>Used</span>
                            <span class="metric-value" data-node="{{.NodeName}}" data-metric="memory-used">{{printf "%.1fG" .MemoryUsed}}</span>
                        </div>
                        <div class="detail-row">
                            <span>Free</span>
                            <span class="metric-value" data-node="{{.NodeName}}" data-metric="memory-free">{{printf "%.1fG" .MemoryFree}}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Network Card -->
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">üåê NETWORK</span>
                        <span class="metric-value main-value" data-node="{{.NodeName}}" data-metric="network-total">{{printf "%.1fM" .NetworkTotal}}</span>
                    </div>
                    <div class="metric-details">
                        <div class="detail-row">
                            <span>RX</span>
                            <span class="metric-value" data-node="{{.NodeName}}" data-metric="network-rx">{{printf "%.1fM" .NetworkRX}}</span>
                        </div>
                        <div class="detail-row">
                            <span>TX</span>
                            <span class="metric-value" data-node="{{.NodeName}}" data-metric="network-tx">{{printf "%.1fM" .NetworkTX}}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Disk Card -->
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">üíæ DISK</span>
                        <span class="metric-value main-value" data-node="{{.NodeName}}" data-metric="disk-total">{{printf "%.1fM" .DiskTotal}}</span>
                    </div>
                    <div class="metric-details">
                        <div class="detail-row">
                            <span>Read</span>
                            <span class="metric-value" data-node="{{.NodeName}}" data-metric="disk-read">{{printf "%.1fM" .DiskRead}}</span>
                        </div>
                        <div class="detail-row">
                            <span>Write</span>
                            <span class="metric-value" data-node="{{.NodeName}}" data-metric="disk-write">{{printf "%.1fM" .DiskWrite}}</span>
                        </div>
                    </div>
                </div>
            </div>
            {{end}}
        </div>
        
        <!-- Section Separator -->
        <div class="section-separator">
            <h2 class="section-title">üì¶ PODS</h2>
        </div>
        
        <div id="podsList" hx-get="/pods/{{.NodeName}}/fragment" hx-trigger="every 2s" hx-swap="innerHTML">
            <div class="pods-container">
                {{range .Pods}}
                <div class="pod-card">
                    <div class="pod-header">
                        <div class="pod-name">{{.Name}}</div>
                        <div class="pod-status {{if eq .PID -1}}pod-error{{else}}pod-running{{end}}">
                            {{if eq .PID -1}}ERROR{{else}}RUNNING{{end}}
                        </div>
                    </div>
                    <div class="pod-details">
                        <div class="detail-row">
                            <span class="detail-label">Container ID:</span>
                            <span class="detail-value container-id">{{.ContainerID}}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Process ID:</span>
                            <span class="detail-value pid">
                                {{if eq .PID -1}}Not Found{{else}}{{.PID}}{{end}}
                            </span>
                        </div>
                    </div>
                </div>
                {{else}}
                <div class="empty-state">
                    <h3>No pods found</h3>
                    <p>No pods are currently running on this node.</p>
                </div>
                {{end}}
            </div>
        </div>

    </div>

    <script>
        // Store previous values for change detection
        let previousValues = new Map();

        // Normalize value for comparison (remove extra spaces, standardize format)
        function normalizeValue(value) {
            if (!value) return '';
            return value.trim()
                       .replace(/\s+/g, ' ')  // Replace multiple spaces with single space
                       .replace(/\s*([%KMGTB]+)\s*/g, '$1')  // Remove spaces around units
                       .replace(/(\d+)\.0+([%KMGTB])/g, '$1$2');  // Remove trailing zeros: "23.0%" -> "23%"
        }

        // Initialize or update value tracking
        function trackValueChanges() {
            const elements = document.querySelectorAll('[data-node][data-metric], [data-pod][data-metric], [data-process][data-metric]');
            
            elements.forEach(element => {
                const nodeId = element.dataset.node || element.dataset.pod || element.dataset.process;
                const metric = element.dataset.metric;
                const key = `${nodeId}-${metric}`;
                
                let currentValue;
                
                // Extract current value from different element types
                if (element.classList.contains('section-value')) {
                    // Extract from parentheses: "(23.4%)" -> "23.4%"
                    const match = element.textContent.match(/\(([^)]+)\)/);
                    currentValue = match ? match[1] : element.textContent;
                } else if (element.classList.contains('metric-value')) {
                    currentValue = element.textContent;
                } else {
                    // For spans with nested metric-value
                    const valueSpan = element.querySelector('.metric-value');
                    if (valueSpan) {
                        currentValue = valueSpan.textContent;
                    } else {
                        // Extract value after colon: "User: 23.4%" -> "23.4%"
                        const match = element.textContent.match(/:\s*([0-9.]+[%GMKTB\s]*)/);
                        currentValue = match ? match[1] : element.textContent;
                    }
                }
                
                // Normalize both values for comparison
                const normalizedCurrent = normalizeValue(currentValue);
                const normalizedPrevious = previousValues.has(key) ? normalizeValue(previousValues.get(key)) : '';
                
                // Check if value actually changed (after normalization)
                if (normalizedPrevious && normalizedPrevious !== normalizedCurrent) {
                    // Value changed - animate it
                    animateValueChange(element);
                }
                
                // Store current value for next comparison (store normalized version)
                previousValues.set(key, normalizedCurrent);
            });
        }

        function animateValueChange(element) {
            // Add animation class
            element.classList.add('value-changed');
            
            // Also animate nested metric-value spans if they exist
            const metricValues = element.querySelectorAll('.metric-value');
            metricValues.forEach(span => {
                span.classList.add('value-changed');
            });
            
            // Remove animation class after animation completes (1.5 seconds)
            setTimeout(() => {
                element.classList.remove('value-changed');
                metricValues.forEach(span => {
                    span.classList.remove('value-changed');
                });
            }, 1500);
        }

        // Initialize tracking on first load
        document.addEventListener('DOMContentLoaded', function() {
            trackValueChanges();
        });

        // Track changes after each HTMX update (including pod metrics)
        document.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'nodeMetrics' || evt.detail.target.id === 'podsList') {
                trackValueChanges();
            }
        });
    </script>
</body>
</html>